<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商家管理</title>
    <style>
        body { margin: 0; padding: 10px; font-family: Arial; }
        .order-list { display: grid; gap: 10px; }
        .order-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .order-id { color: #666; }
        .status { padding: 3px 8px; border-radius: 10px; }
        .preparing { background: #2196F3; color: white; }
        .completed { background: #4CAF50; color: white; }
        .item-list { margin: 10px 0; }
        .item { display: flex; align-items: center; margin: 5px 0; }
        .item img { width: 40px; height: 40px; object-fit: cover; margin-right: 10px; }
    </style>
</head>
<body>
<h2>订单管理</h2>
<div class="order-list" id="orderList"></div>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBnESO0rNf27G75vX7eADhRsTb2L_XUMJo",
        authDomain: "diancai-fac69.firebaseapp.com",
        databaseURL: "https://diancai-fac69-default-rtdb.firebaseio.com",
        projectId: "diancai-fac69",
        storageBucket: "diancai-fac69.firebasestorage.app",
        messagingSenderId: "57215593640",
        appId: "1:57215593640:web:c8e48c644cc61cba27269d",
        measurementId: "G-QD8L5YNL1B"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    database.ref('orders').orderByChild('timestamp').on('value', async snapshot => {
        const orders = snapshot.val();
        const orderList = document.getElementById('orderList');
        orderList.innerHTML = orders ? '' : '<p>暂无订单</p>';

        const menu = await database.ref('menu').once('value').then(s => s.val());

        Object.keys(orders).forEach(orderKey => {
            const order = orders[orderKey];
            const card = document.createElement('div');
            card.className = 'order-card';

            let itemsHtml = '';
            Object.keys(order.items).forEach(itemKey => {
                let itemInfo = {};
                Object.keys(menu).some(cat => {
                    if(menu[cat].items[itemKey]) {
                        itemInfo = menu[cat].items[itemKey];
                        return true;
                    }
                });

                itemsHtml += `
                        <div class="item">
                            <img src="${itemInfo.image || ''}">
                            <div>
                                <div>${itemInfo.name}</div>
                                <small>数量: ${order.items[itemKey]}</small>
                            </div>
                        </div>
                    `;
            });

            card.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">订单号：${orderKey.slice(-6)}</div>
                        <div class="status ${order.status}">${order.status === 'preparing' ? '制作中' : '已完成'}</div>
                    </div>
                    <div class="item-list">${itemsHtml}</div>
                    ${order.status === 'preparing' ?
                `<button onclick="completeOrder('${orderKey}')" style="width:100%; padding:8px;">标记完成</button>` : ''}
                `;

            orderList.appendChild(card);
        });
    });

    function completeOrder(orderKey) {
        if (confirm('确认订单已完成？')) {
            database.ref(`orders/${orderKey}`).update({
                status: 'completed',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }
</script>
</body>
</html>
